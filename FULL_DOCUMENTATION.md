# Документация проекта FilmHub

## 1. Название и обзор проекта

**FilmHub** — это веб-приложение на PHP, предназначенное для управления и отображения каталога фильмов. Оно позволяет пользователям просматривать фильмы, детальную информацию о них, взаимодействовать, добавляя комментарии, оценки и помечая избранные фильмы, а также управлять своими личными профилями. Административная панель предоставляет функционал для модерации контента и управления пользователями.

**Используемые основные технологии:**
*   **Бэкенд:** PHP (в основном процедурный с классами для компонентов MVC)
*   **База данных:** MySQL (взаимодействие через PDO)
*   **Фронтенд:** HTML, CSS (Bootstrap 5 через CDN, кастомные `app.css` и `admin.css`), JavaScript (чистый JS, SweetAlert2 через CDN)
*   **Веб-сервер:** Apache (настроен с `.htaccess` для перезаписи URL)

## 2. Архитектура

Проект следует модифицированному архитектурному паттерну Model-View-Controller (MVC), разделенному на публичное приложение и административную панель, каждая со своей маршрутизацией и контроллерами.

### Реализация паттерна MVC
*   **Модели (`model/`, `admin/modelAdmin/`):** Обрабатывают всю логику, связанную с данными, напрямую взаимодействуя с базой данных MySQL. Каждая значимая сущность (Фильм, Пользователь, Жанр, Комментарий, Рейтинг, Избранное) имеет свой класс модели, расширяющий `BaseModel` для абстракции подключения к базе данных.
*   **Представления (`view/`, `admin/viewAdmin/`):** Отвечают за отрисовку пользовательского интерфейса. Это PHP-файлы, содержащие HTML, часто включающие общий `layout.php` для единообразного дизайна. Данные передаются в представления через `extract()`.
*   **Контроллеры (`controller/controller.php`, `admin/controllerAdmin/`):** Действуют как посредники, получая ввод пользователя, обрабатывая его (часто вызывая методы моделей), а затем выбирая соответствующее представление для отображения результата. Они также управляют данными сессии для аутентификации и флеш-сообщений.

### Механизм маршрутизации
Приложение использует кастомную, файловую систему маршрутизации.

*   **Публичная маршрутизация (`route/routing.php`):**
    *   Разбирает `REQUEST_URI` для определения запрошенного пути.
    *   Использует серию операторов `if-elseif` для сопоставления пути с конкретными методами в основном классе `Controller`.
    *   Поддерживает как GET, так и POST запросы для определенных действий (например, комментирование, переключение избранного).
    *   Обрабатывает базовый путь URL для развертывания в подпапках (например, `/filmhub`).

*   **Административная маршрутизация (`admin/routeAdmin/routingAdmin.php`):**
    *   Аналогична публичной маршрутизации, но специально для административных действий.
    *   Маршрутизирует запросы к классам `controllerAdmin`, `controllerAdminMovies` и `controllerAdminUsers`.
    *   Обеспечивает аутентификацию администратора для большинства маршрутов.

### Сводка по схеме базы данных (`filmhub.sql`)
База данных `filmhub` содержит следующие таблицы:

*   **`users`:** Хранит информацию о пользователях (id, логин, email, хеш пароля, роль, имя файла аватара, метки времени). `role` может быть 'user' или 'admin'.
*   **`movies`:** Хранит детали фильмов (id, название, оригинальное название, описание, год, продолжительность, страна, режиссер, имя файла/URL постера, ID трейлера YouTube, genre_id, метки времени).
*   **`genres`:** Хранит названия жанров фильмов (id, название, slug, метка времени).
*   **`comments`:** Хранит комментарии пользователей к фильмам (id, movie_id, user_id, текст, статус ('visible'/'hidden'), метки времени).
*   **`ratings`:** Хранит оценки пользователей для фильмов (id, user_id, movie_id, рейтинг (1-10), метки времени).
*   **`favorites`:** Хранит связи избранных фильмов пользователей (id, user_id, movie_id, метка времени).
*   **`movie_rating_stats`:** Денормализованная таблица для кэширования средних оценок фильмов и их количества, обновляется при отправке новых оценок.

Связи определены с внешними ключами и каскадными правилами для обеспечения целостности данных (например, удаление пользователя каскадно удаляет его комментарии, оценки и избранные).

## 3. Основные компоненты

### Контроллеры
*   **`controller/controller.php` (Публичный контроллер):**
    *   Управляет публичными страницами: главная (`StartSite`), все фильмы (`AllMovies`), жанры (`AllGenres`), фильмы по жанрам (`MoviesByGenreID`), детали отдельного фильма (`MovieByID`).
    *   Обрабатывает действия пользователя: `InsertComment`, `favoriteToggle`, `RateMovie`, регистрацию пользователя (`registerForm`, `registerUser`), вход (`loginForm`, `loginUser`), выход (`logoutUser`), управление профилем (`profile`, `profileUpdate`, `profileAvatarUpdate`, `profileAvatarDelete`, `profileDelete`).
    *   Включает вспомогательные методы для вычисления базового URL (`base`), отрисовки представлений (`view`) и перенаправлений (`redirect`).
    *   `requireAuth()`: Гарантирует, что пользователь вошел в систему перед доступом к определенным страницам.
    *   `error404()`: Отображает страницу ошибки 404.

*   **`admin/controllerAdmin/controllerAdmin.php` (Базовый административный контроллер):**
    *   Обрабатывает аутентификацию администратора (`formLoginSite`, `loginAction`, `logoutAction`).
    *   `requireAdmin()`: Обеспечивает аутентификацию администратора.
    *   `dashboard()`: Отображает панель управления администратора.
    *   Предоставляет базовые вспомогательные функции `view` и `redirect` для административной панели.

*   **`admin/controllerAdmin/controllerAdminMovies.php` (Административный контроллер фильмов):**
    *   Управляет операциями CRUD (создание, чтение, обновление, удаление) для фильмов в административной панели.
    *   `movieList()`: Отображает все фильмы.
    *   `movieAddForm()`, `movieAddResult()`: Добавляет новые фильмы, включая загрузку и обработку постеров.
    *   `movieEditForm()`, `movieEditResult()`: Редактирует существующие фильмы, также обрабатывая обновления постеров.
    *   `movieDeleteForm()`, `movieDeleteResult()`: Удаляет фильмы.
    *   `handlePosterUpload()`: Утилита для безопасной загрузки постеров фильмов.

*   **`admin/controllerAdmin/controllerAdminUsers.php` (Административный контроллер пользователей/модерации):**
    *   Управляет пользователями, комментариями, избранными и оценками с точки зрения администратора.
    *   `usersList()`: Отображает всех пользователей.
    *   `userAvatarForm()`, `userAvatarUpdate()`, `userAvatarDelete()`: Управляет аватарами пользователей.
    *   `commentsList()`, `commentToggle()`, `commentDelete()`: Модерирует комментарии.
    *   `favoritesList()`, `favoriteDelete()`: Управляет избранными пользователя.
    *   `ratingsList()`, `ratingDelete()`: Управляет оценками фильмов.
    *   `genresList()`, `genreAddForm()`, `genreAddResult()`, `genreDelete()`: Управляет жанрами.
    *   `userDeleteForm()`, `userDeleteResult()`: Удаляет пользователей.
    *   Включает несколько вспомогательных методов для операций с файловой системой, связанных с аватарами, и проверок столбцов базы данных.

### Модели
Все модели расширяют `BaseModel`, который предоставляет статический метод `db()` для получения экземпляра `Database`.

*   **`model/BaseModel.php`:** Простой базовый класс, предоставляющий метод `db()` для доступа к базе данных.
*   **`model/CommentModel.php`:** Обрабатывает комментарии: `insertComment`, `getVisibleCommentsByMovieID`, `getCommentCountByMovieID`. Также `getAllComments` и `setStatus` для административной модерации.
*   **`model/FavoriteModel.php`:** Управляет избранными пользователя: `isFavorite`, `add`, `remove`, `toggle`, `getUserFavorites`. `getAllFavorites` для администратора.
*   **`model/GenreModel.php`:** Управляет жанрами: `getAllGenres`, `getGenreByID`, `getGenreBySlug`. Административная модель `modelAdminGenres.php` содержит `createFromPost`, `deleteGenre`.
*   **`model/MovieModel.php`:** Обрабатывает данные о фильмах: `getLastMovies`, `getAllMovies`, `getMovieByID`, `getMoviesByGenreID`. Административная модель `modelAdminMovies.php` содержит `createFromPost`, `updateFromPost`, `deleteByID`.
*   **`model/RatingModel.php`:** Управляет оценками фильмов: `setRating`, `getUserRating`, `getMovieStats` и `recalcStats` для обновления таблицы `movie_rating_stats`. `getAllRatings` для администратора.
*   **`model/UserModel.php`:** Управляет учетными записями пользователей: `registerFromPost`, `loginFromPost`, `logout`, `getByID`, `updateProfile`, `getAvatarFilename`, `updateAvatar`, `clearAvatar`, `deleteUser`.

### Представления
*   Представления — это простые PHP-файлы в каталогах `view/` и `admin/viewAdmin/`.
*   Многие представления включают `layout.php` (`view/templates/layout.php` для публичной части, `admin/viewAdmin/layout.php` для административной части), который предоставляет основную структуру HTML, навигацию и общие элементы.
*   Они получают данные через `extract()` из контроллеров.
*   Широко используется `htmlspecialchars()` для экранирования вывода с целью предотвращения XSS.
*   Примеры: `start.php` (главная страница), `allMovies.php`, `movie.php` (просмотр одного фильма), `profile.php`, `formLogin.php`, `usersList.php` (админка), `movieEditForm.php` (админка).

### Класс базы данных (`inc/Database.php`)
*   Предоставляет простую обертку вокруг PHP PDO для взаимодействия с базой данных.
*   По умолчанию настроен для MySQL с базой данных `filmhub`, пользователем `root` и пустым паролем.
*   Методы: `__construct` (устанавливает соединение), `getAll` (получает несколько строк), `getOne` (получает одну строку), `executeRun` (выполняет операторы DML), `lastInsertId`.
*   Использует подготовленные операторы для предотвращения SQL-инъекций.

### Вспомогательные функции (`inc/media.php`, `admin/inc/helpers.php`)
*   **`inc/media.php`:**
    *   `fh_base()`: Определяет базовый URL проекта (полезно для развертывания в подпапках).
    *   `fh_abs_asset()`: Генерирует абсолютные URL для ассетов (CSS, JS, изображения).
    *   `movie_poster_url()`: Стандартизирует URL для постеров фильмов.
    *   `fh_slug()`: Генерирует URL-дружественные "слаги".
    *   `fh_movie_poster_filename()`: Генерирует стандартное имя файла для постеров фильмов.
*   **`admin/inc/helpers.php`:**
    *   `h()`: Сокращение для `htmlspecialchars`.
    *   `view_value()`: Безопасно извлекает значение из массива с возможностью указания значения по умолчанию.
    *   `user_avatar_url()`: Генерирует URL для аватара пользователя, обрабатывая различные методы хранения.

### Публичные ассеты (`public/css/`, `public/js/`, `admin/public/css/`, `admin/public/js/`)
*   **CSS:** `app.css` определяет основные стили публичного сайта, включая "темную тему кинотеатра" и адаптивные настройки. `admin.css` предоставляет специфические стили для административного интерфейса, интегрируясь с Bootstrap.
*   **JavaScript:** `app.js` содержит небольшие клиентские функции, такие как плавная прокрутка к якорям и быстрая обратная связь пользовательского интерфейса для оценок. `profile.js` обрабатывает изменение размера изображений аватаров на стороне клиента и загрузку через AJAX для профилей пользователей. `admin.js` обрабатывает логику переключения боковой панели и диалоги подтверждения для административных действий.

## 4. Ключевые функциональные возможности

### Аутентификация/авторизация пользователя
*   **Регистрация:** Пользователи могут зарегистрироваться через `registerForm`, который вызывает `UserModel::registerFromPost`. Выполняется проверка ввода и уникальности логина/email.
*   **Вход:** Пользователи могут войти в систему, используя свой email или логин и пароль (`loginForm`, `UserModel::loginFromPost`). Сессии используются для поддержания состояния входа.
*   **Выход:** Пользователи могут выйти из системы, что уничтожает сессию (`logoutUser`, `UserModel::logout`).
*   **Роли администраторов:** Пользователи с ролью `admin` могут получить доступ к панели `/admin`, что обеспечивается `requireAdmin()` в административных контроллерах.

### Управление фильмами (публичная и административная части)
*   **Публичный просмотр:**
    *   `StartSite`: Отображает последние фильмы.
    *   `AllMovies`: Выводит список всех фильмов.
    *   `AllGenres`: Выводит список всех жанров.
    *   `MoviesByGenreID`: Выводит список фильмов, отфильтрованных по определенному жанру.
    *   `MovieByID`: Показывает подробную информацию об одном фильме, включая комментарии, оценки и трейлер.
*   **Административные операции CRUD (`controllerAdminMovies`):**
    *   **Добавление фильма:** `movieAddForm` и `movieAddResult` позволяют администраторам добавлять новые фильмы с деталями, жанром и загрузкой постера (локальный файл или URL).
    *   **Редактирование фильма:** `movieEditForm` и `movieEditResult` позволяют редактировать существующие детали фильма, включая обновление постера.
    *   **Удаление фильма:** `movieDeleteForm` и `movieDeleteResult` облегчают удаление фильмов, также удаляя связанные файлы постеров.
*   **Управление жанрами (`controllerAdminUsers` и `modelAdminGenres`):**
    *   `genresList`: Выводит список всех жанров в административной панели.
    *   `genreAddForm`, `genreAddResult`: Добавляет новые жанры, автоматически генерируя "слаги", если они не предоставлены.
    *   `genreDelete`: Удаляет жанры.

### Взаимодействие с пользователем
*   **Комментарии:** Пользователи могут добавлять комментарии к фильмам (`InsertComment`). Комментарии могут быть переключены (видимые/скрытые) и удалены администраторами (`commentToggle`, `commentDelete` в `controllerAdminUsers`).
*   **Оценки:** Пользователи могут оценивать фильмы от 1 до 10 (`RateMovie`). Оценки сохраняются, и `movie_rating_stats` динамически обновляются, чтобы отражать средние оценки. Администраторы могут просматривать и удалять оценки (`ratingsList`, `ratingDelete`).
*   **Избранное:** Пользователи могут добавлять/удалять фильмы в свой список избранного (`favoriteToggle`). Администраторы могут просматривать и удалять записи избранного (`favoritesList`, `favoriteDelete`).

### Управление профилем пользователя
*   **Просмотр профиля:** `profile` отображает логин пользователя, email и его избранные фильмы.
*   **Обновление профиля:** `profileUpdate` позволяет пользователям изменять свой логин и email, с проверкой на уникальность.
*   **Управление аватарами:**
    *   `profileAvatarUpdate` позволяет пользователям загружать новое изображение аватара, которое изменяется на стороне клиента (через `profile.js`), а затем загружается на сервер. Старые файлы аватаров удаляются.
    *   `profileAvatarDelete` удаляет текущий аватар пользователя.
    *   Административная панель (`userAvatarForm`, `userAvatarUpdate`, `userAvatarDelete`) предоставляет аналогичную функциональность для администраторов по управлению аватарами любого пользователя.
*   **Удаление учетной записи:** `profileDelete` позволяет пользователям навсегда удалить свою учетную запись, включая все связанные данные (комментарии, оценки, избранное) из-за каскадных правил базы данных или явного удаления в `UserModel::deleteUser`.

## 5. Настройка и развертывание

1.  **Веб-сервер:** Установите веб-сервер (например, Apache) с поддержкой PHP.
2.  **База данных:** Установите MySQL или MariaDB.
3.  **Размещение проекта:** Поместите каталог `filmhub` в корневой каталог вашего веб-сервера (например, `htdocs` для XAMPP).
4.  **Создание базы данных:** Создайте базу данных с именем `filmhub` на вашем сервере MySQL.
5.  **Импорт схемы:** Импортируйте файл `filmhub.sql` в базу данных `filmhub`.
6.  **Конфигурация базы данных:** При необходимости обновите учетные данные базы данных в `inc/Database.php`.
7.  **Перезапись URL:** Убедитесь, что ваша конфигурация Apache разрешает файлы `.htaccess` для включения чистых URL.
8.  **Доступ:** Перейдите в веб-браузере по адресу `http://localhost/filmhub/` (или по вашему настроенному URL).
9.  **Доступ к админке:** Панель администратора доступна по адресу `http://localhost/filmhub/admin/`. Учетные данные администратора по умолчанию указаны в `GEMINI.md` и `filmhub.sql`.

## 6. Стиль кода и соглашения

*   **PHP:**
    *   Использует `declare(strict_types=1);` для строгой проверки типов.
    *   Классы и методы используют `camelCase`.
    *   Широко используется `$_SESSION` для состояния пользователя и флеш-сообщений.
    *   `htmlspecialchars()` широко используется для экранирования вывода.
    *   Взаимодействие с базой данных централизовано в классе `Database` и моделях.
*   **HTML/CSS/JS:**
    *   Использует Bootstrap 5 для основных компонентов пользовательского интерфейса и адаптивности.
    *   Кастомные CSS-файлы (`app.css`, `admin.css`) переопределяют и расширяют стили Bootstrap для создания уникальной темы.
    *   JavaScript в основном является чистым JS, с некоторыми внешними библиотеками (SweetAlert2) для улучшения UI/UX.
    *   Клиентская обработка изображений для аватаров для оптимизации загрузки.
*   **Комментарии:** Код содержит комментарии, преимущественно на русском языке, объясняющие логику, назначение функций и некоторые заметки по разработке.
*   **Константы/Конфигурация:** Учетные данные базы данных жестко закодированы в `inc/Database.php`, что может быть кандидатом для внешней конфигурации (например, файл `.env`) в производственной среде.
*   **Безопасность:** Применяются базовые меры безопасности, такие как хеширование паролей (`password_hash`, `password_verify`) и подготовленные операторы. Однако управление сессиями может быть дополнительно усилено.